<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Check-In/Out</title>
  <style>
    :root { --primary:#3498db; --bg:#f4f7f6; }
    body{font-family:Arial;background:var(--bg);margin:0;}
    header{background:var(--primary);color:#fff;padding:1rem;text-align:center;}
    .screen{max-width:600px;margin:1rem auto;background:#fff;padding:1rem;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,.1);}
    h2{color:var(--primary);text-align:center;}
    label{font-weight:bold;display:block;margin-top:1rem;}
    input,select,textarea{width:100%;padding:.7rem;margin-top:.3rem;border:1px solid #ddd;border-radius:8px;}
    button{width:100%;margin-top:1rem;padding:1rem;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
    .main-btn{background:var(--primary);color:#fff;}
    .back-btn{background:#888;color:#fff;}
    video,img{width:100%;border-radius:8px;margin-top:.5rem;}
    .hidden{display:none;}
    .success{color:green;text-align:center;}
    .error{color:red;text-align:center;}
  </style>
</head>
<body>
  <header><div id="user-info"></div></header>
  <main>
    <div id="dashboard-screen" class="screen">
      <p id="status-message"></p>
      <button id="check-in-btn" class="main-btn">Check In</button>
      <button id="check-out-btn" class="main-btn">Check Out</button>
    </div>

    <!-- Check-In -->
    <div id="check-in-screen" class="screen hidden">
      <h2>Check-In</h2>
      <form id="check-in-form">
        <label>Planned Route?</label>
        <select id="planned-route" required>
          <option value="">Select...</option>
          <option value="Yes">Yes</option><option value="No">No</option>
        </select>
        <label>Select Route</label>
        <select id="route-list-in" required></select>
        <label>Take Meter Reading Photo</label>
        <video id="video-in" autoplay playsinline></video>
        <img id="photo-preview-in" class="hidden">
        <button type="button" id="start-camera-in">Open Camera</button>
        <button type="button" id="snap-photo-in" class="hidden">Snap Photo</button>
        <button type="submit" class="main-btn">Submit Check-In</button>
        <button type="button" class="back-btn">Back</button>
      </form>
    </div>

    <!-- Check-Out -->
    <div id="check-out-screen" class="screen hidden">
      <h2>Check-Out</h2>
      <form id="check-out-form">
        <label>Completed Route</label>
        <select id="route-list-out" required></select>
        <label>Photo/Receipt Option</label>
        <select id="photo-option" required>
          <option value="none">No Photo</option>
          <option value="meter">Meter Reading</option>
          <option value="ticket">Ticket/Receipt</option>
        </select>
        <div id="photo-upload-section" class="hidden">
          <video id="video-out" autoplay playsinline></video>
          <img id="photo-preview-out" class="hidden">
          <button type="button" id="start-camera-out">Open Camera</button>
          <button type="button" id="snap-photo-out" class="hidden">Snap Photo</button>
        </div>
        <label>Travel Cost</label><input type="number" id="travel-cost">
        <label>Stay Cost</label><input type="number" id="stay-cost">
        <label>Food Cost</label><input type="number" id="food-cost">
        <label>Notes</label><textarea id="notes"></textarea>
        <button type="submit" class="main-btn">Submit Check-Out</button>
        <button type="button" class="back-btn">Back</button>
      </form>
    </div>
  </main>

<script>
const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbyDkqGz9MARgSyl54RKqxi57I1EaNc8iVtAPy3M0rl3xGN-0XehAQrDZBTea8EzjzeG/exec";

let currentUser=null;
try{currentUser=JSON.parse(localStorage.getItem("user"));}catch(e){}
if(!currentUser||!currentUser.email){window.location.href="login.html";}
document.getElementById("user-info").textContent="Logged in as: "+currentUser.email;

function showScreen(id){document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));document.getElementById(id).classList.remove("hidden");}
function showMessage(msg,type){const el=document.getElementById("status-message");el.textContent=msg;el.className=type;}

async function fetchRoutes(email){const r=await fetch(`${SPREADSHEET_URL}?action=getRoutes&email=${encodeURIComponent(email)}`);const d=await r.json();return d.status==="success"?d.routes:[];}
async function populateRoutes(sel){const routes=await fetchRoutes(currentUser.email);sel.innerHTML='<option value="">Select...</option>';routes.forEach(rt=>{const o=document.createElement("option");o.value=rt;o.textContent=rt;sel.appendChild(o);});}
async function postData(obj){const r=await fetch(SPREADSHEET_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(obj)});return await r.json();}

let stream=null,photoIn=null,photoOut=null;
async function openCamera(video,snap,prev){try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});video.srcObject=stream;snap.classList.remove("hidden");prev.classList.add("hidden");}catch(e){alert("Camera not available");}}
function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop());}}

document.getElementById("check-in-btn").onclick=async()=>{await populateRoutes(document.getElementById("route-list-in"));showScreen("check-in-screen");};
document.getElementById("check-out-btn").onclick=async()=>{await populateRoutes(document.getElementById("route-list-out"));showScreen("check-out-screen");};
document.querySelectorAll(".back-btn").forEach(b=>b.onclick=()=>{stopCamera();showScreen("dashboard-screen");});

const vIn=document.getElementById("video-in"),sIn=document.getElementById("snap-photo-in"),pIn=document.getElementById("photo-preview-in");
document.getElementById("start-camera-in").onclick=()=>openCamera(vIn,sIn,pIn);
sIn.onclick=()=>{const c=document.createElement("canvas");c.width=vIn.videoWidth;c.height=vIn.videoHeight;c.getContext("2d").drawImage(vIn,0,0);photoIn=c.toDataURL("image/jpeg",0.7);pIn.src=photoIn;pIn.classList.remove("hidden");stopCamera();};

const vOut=document.getElementById("video-out"),sOut=document.getElementById("snap-photo-out"),pOut=document.getElementById("photo-preview-out");
document.getElementById("photo-option").onchange=()=>{document.getElementById("photo-upload-section").classList.toggle("hidden",document.getElementById("photo-option").value==="none");};
document.getElementById("start-camera-out").onclick=()=>openCamera(vOut,sOut,pOut);
sOut.onclick=()=>{const c=document.createElement("canvas");c.width=vOut.videoWidth;c.height=vOut.videoHeight;c.getContext("2d").drawImage(vOut,0,0);photoOut=c.toDataURL("image/jpeg",0.7);pOut.src=photoOut;pOut.classList.remove("hidden");stopCamera();};

document.getElementById("check-in-form").onsubmit=async e=>{e.preventDefault();const obj={type:"CheckIn",name:currentUser.name,email:currentUser.email,route:document.getElementById("route-list-in").value,planned:document.getElementById("planned-route").value,photoData:photoIn};const r=await postData(obj);showMessage(r.status==="success"?"Check-In Saved":"Error: "+r.message,r.status);photoIn=null;stopCamera();showScreen("dashboard-screen");};
document.getElementById("check-out-form").onsubmit=async e=>{e.preventDefault();const obj={type:"CheckOut",name:currentUser.name,email:currentUser.email,route:document.getElementById("route-list-out").value,meterOption:document.getElementById("photo-option").value,travelCost:document.getElementById("travel-cost").value,stayCost:document.getElementById("stay-cost").value,foodCost:document.getElementById("food-cost").value,notes:document.getElementById("notes").value,photoData:photoOut};const r=await postData(obj);showMessage(r.status==="success"?"Check-Out Saved":"Error: "+r.message,r.status);photoOut=null;stopCamera();showScreen("dashboard-screen");};
</script>
</body>
</html>
